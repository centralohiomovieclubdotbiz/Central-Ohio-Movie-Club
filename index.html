<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Central Ohio Movie Club</title>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #fafafa; }
    h1 { text-align: center; margin-bottom: 6px; }
    #last-updated { margin: 8px 0 16px; font-size: 0.9em; color: #555; text-align: center; }
    table.dataTable thead th { white-space: nowrap; }
    table { width: 100%; }
    #movies thead tr.filters th { padding: 4px 8px; }
    #movies thead tr.filters input,
    #movies thead tr.filters select { width: 98%; padding: 4px 6px; }
  </style>
</head>
<body>
  <h1>Central Ohio Movie Club</h1>
  <div id="last-updated">Loading update info...</div>

  <table id="movies" class="display">
    <thead>
      <tr>
        <th>Theater</th>
        <th>Movie</th>
        <th>Day</th>
        <th>Date</th>
        <th>Time</th>
        <th>Runtime</th>
        <th style="display:none;">ISO Date</th>
        <th style="display:none;">Time 24h</th>
      </tr>
      <tr class="filters">
        <th>
          <select id="theater-filter">
            <option value="">All theaters</option>
          </select>
        </th>
        <th><input type="text" placeholder="Filter movie"></th>
        <th><input type="text" placeholder="Filter day"></th>
        <th><input type="date" id="date-filter-col"></th>
        <th>
          <select id="time-filter">
            <option value="">All times</option>
            <option value="AM">AM</option>
            <option value="PM">PM</option>
          </select>
        </th>
        <th><input type="text" placeholder="Filter runtime"></th>
        <th style="display:none;"></th>
        <th style="display:none;"></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <script>
    const JSON_URL = "https://centralohiomovieclubdotbiz.github.io/Central-Ohio-Movie-Club/cinemas.json";

    function prettyTheater(keyOrName) {
      const map = {
        "gateway": "Gateway Film Center",
        "drexel": "Drexel Theatre",
        "studio35": "Studio 35"
      };
      return map[keyOrName] || keyOrName;
    }

    function pad(n) { return n < 10 ? "0" + n : "" + n; }

    function toAmPm(date) {
      return date.toLocaleTimeString("en-US", {
        hour: "numeric",
        minute: "2-digit",
        hour12: true
      });
    }

    function to24h(date) {
      return pad(date.getHours()) + ":" + pad(date.getMinutes());
    }

    function formatRuntime(minutes) {
      if (minutes == null || isNaN(minutes)) return "Unknown";
      const h = Math.floor(minutes / 60);
      const m = minutes % 60;
      const hm = h > 0 ? `${h}h ${m}m` : `${m}m`;
      return `${minutes} min (${hm})`;
    }

    async function fetchLastModified() {
      try {
        const resp = await fetch(JSON_URL, { method: "HEAD" });
        const lm = resp.headers.get("last-modified");
        if (lm) {
          const formatted = new Date(lm).toLocaleString("en-US", {
            timeZone: "America/New_York",
            dateStyle: "medium",
            timeStyle: "short"
          });
          document.getElementById("last-updated").textContent = `Last updated: ${formatted} ET`;
        } else {
          document.getElementById("last-updated").textContent = "Last updated: Unknown";
        }
      } catch {
        document.getElementById("last-updated").textContent = "Last updated: Unknown";
      }
    }

    (async function init() {
      await fetchLastModified();

      const resp = await fetch(JSON_URL);
      const json = await resp.json();

      const rows = [];
      const theaterSet = new Set();

      for (const [theaterKey, movies] of Object.entries(json)) {
        const theaterName = prettyTheater(theaterKey);
        theaterSet.add(theaterName);
        for (const movie of movies) {
          const runtimeDisplay = formatRuntime(movie.runtime);
          for (const show of movie.showtimes || []) {
            let dstr = "";
            if (typeof show === "object") {
              dstr = show.datetime;
            } else {
              const i = show.indexOf("(");
              dstr = i > -1 ? show.slice(0, i).trim() : show.trim();
            }

            const jsDate = new Date(dstr.replace(" ", "T"));
            const isoDate = dstr.slice(0, 10);
            const day = jsDate.toLocaleDateString("en-US", { weekday: "long" });
            const dateDisp = jsDate.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
            const timeDisp = toAmPm(jsDate);
            const time24 = to24h(jsDate);

            rows.push([
              theaterName,
              movie.title,
              day,
              dateDisp,
              timeDisp,
              runtimeDisplay,
              isoDate,
              time24
            ]);
          }
        }
      }

      const table = $('#movies').DataTable({
        data: rows,
        columns: [
          { title: "Theater" },
          { title: "Movie" },
          { title: "Day" },
          { title: "Date" },
          {
            title: "Time",
            render: function (data, type, row) {
              if (type === 'sort' || type === 'type') return row[7];
              return data;
            }
          },
          { title: "Runtime" },
          { visible: false },
          { visible: false }
        ],
        orderCellsTop: true,
        fixedHeader: true,
        pageLength: 25
      });

      const theaterFilter = document.getElementById("theater-filter");
      [...theaterSet].sort().forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        theaterFilter.appendChild(opt);
      });

      $('#movies thead tr.filters th').each(function (i) {
        const input = $('input', this);
        if (input.length) {
          input.on('keyup change', function () {
            if (table.column(i).search() !== this.value) {
              table.column(i).search(this.value).draw();
            }
          });
        }
      });

      theaterFilter.addEventListener("change", function () {
        const v = this.value;
        if (v) {
          table.column(0).search('^' + v.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '$', true, false).draw();
        } else {
          table.column(0).search("").draw();
        }
      });

      document.getElementById("time-filter").addEventListener("change", function () {
        const val = this.value;
        if (val) {
          table.column(4).search(val, true, false).draw();
        } else {
          table.column(4).search("").draw();
        }
      });

      document.getElementById("date-filter-col").addEventListener("change", function () {
        const val = this.value;
        if (val) {
          table.column(6).search(val, true, false).draw();
        } else {
          table.column(6).search("").draw();
        }
      });
    })();
  </script>
</body>
</html>
