<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Central Ohio Movie Club</title>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #fafafa; }
    h1 { text-align: center; margin-bottom: 6px; }
    #last-updated { margin: 8px 0 16px; font-size: 0.9em; color: #555; text-align: center; }
    .toolbar {
      display: flex; flex-wrap: wrap; gap: 10px; align-items: center;
      justify-content: center; margin-bottom: 12px;
    }
    .toolbar label { font-size: 0.95em; color: #333; }
    .toolbar input, .toolbar select { padding: 6px 8px; font-size: 14px; }
    table.dataTable thead th { white-space: nowrap; }
    table { width: 100%; }
    #movies thead tr.filters th { padding: 4px 8px; }
    #movies thead tr.filters input,
    #movies thead tr.filters select { width: 98%; padding: 4px 6px; }
  </style>
</head>
<body>
  <h1>Central Ohio Movie Club</h1>
  <div id="last-updated">Loading update info...</div>

  <!-- Global toolbar (exact date + AM/PM) -->
  <div class="toolbar">
    <label for="exactDate">Exact date:&nbsp;</label>
    <input type="date" id="exactDate" />
    <label for="ampmGlobal">Time:&nbsp;</label>
    <select id="ampmGlobal">
      <option value="">All</option>
      <option value="AM">AM</option>
      <option value="PM">PM</option>
    </select>
  </div>

  <table id="movies" class="display">
    <thead>
      <tr>
        <th>Theater</th>
        <th>Movie</th>
        <th>Day</th>
        <th>Date</th>
        <th>Time</th>
        <th>Runtime</th>
        <!-- Hidden ISO fields for exact matching/sorting -->
        <th style="display:none;">ISO Date</th>
        <th style="display:none;">Time 24h</th>
      </tr>
      <tr class="filters">
        <!-- Theater dropdown (auto-populated) -->
        <th>
          <select id="theater-filter">
            <option value="">All theaters</option>
          </select>
        </th>
        <th><input type="text" placeholder="Filter movie"></th>
        <th><input type="text" placeholder="Filter day"></th>
        <!-- Date picker in column filter -->
        <th><input type="date" id="date-filter-col"></th>
        <th>
          <select id="time-filter">
            <option value="">All times</option>
            <option value="AM">AM</option>
            <option value="PM">PM</option>
          </select>
        </th>
        <th><input type="text" placeholder="Filter runtime"></th>
        <th style="display:none;"></th>
        <th style="display:none;"></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <script>
    const JSON_URL = "https://centralohiomovieclubdotbiz.github.io/Central-Ohio-Movie-Club/cinemas.json";

    function prettyTheater(keyOrName) {
      const map = {
        "gateway": "Gateway Film Center",
        "drexel": "Drexel Theatre",
        "studio35": "Studio 35"
      };
      return map[keyOrName] || keyOrName;
    }

    function pad(n) { return n < 10 ? "0" + n : "" + n; }

    function toAmPm(date) {
      return date.toLocaleTimeString("en-US", {
        hour: "numeric",
        minute: "2-digit",
        hour12: true
      });
    }

    function to24h(date) {
      return pad(date.getHours()) + ":" + pad(date.getMinutes());
    }

    function formatRuntime(minutes) {
      if (minutes == null || isNaN(minutes)) return "Unknown";
      const h = Math.floor(minutes / 60);
      const m = minutes % 60;
      const hm = h > 0 ? `${h}h ${m}m` : `${m}m`;
      return `${minutes} min (${hm})`;
    }

    async function fetchLastModified() {
      try {
        const resp = await fetch(JSON_URL, { method: "HEAD" });
        const lm = resp.headers.get("last-modified");
        if (lm) {
          const formatted = new Date(lm).toLocaleString("en-US", {
            timeZone: "America/New_York",
            dateStyle: "medium",
            timeStyle: "short"
          });
          document.getElementById("last-updated").textContent = `Last updated: ${formatted} ET`;
        } else {
          document.getElementById("last-updated").textContent = "Last updated: Unknown";
        }
      } catch {
        document.getElementById("last-updated").textContent = "Last updated: Unknown";
      }
    }

    // Global filters
    let exactDateFilter = "";
    let ampmGlobalFilter = "";

    // DataTables global search hook: enforce exact date + AM/PM if set
    $.fn.dataTable.ext.search.push(function(settings, data) {
      const isoDate = data[6];
      const timeStr = data[4];
      const ampm = /AM/i.test(timeStr) ? "AM" : /PM/i.test(timeStr) ? "PM" : "";
      if (exactDateFilter && isoDate !== exactDateFilter) return false;
      if (ampmGlobalFilter && ampm !== ampmGlobalFilter) return false;
      return true;
    });

    (async function init() {
      await fetchLastModified();

      const resp = await fetch(JSON_URL);
      const json = await resp.json();

      const rows = [];
      const theaterSet = new Set();

      for (const [theaterKey, movies] of Object.entries(json)) {
        const theaterName = prettyTheater(theaterKey);
        theaterSet.add(theaterName);
        for (const movie of movies) {
          const runtimeDisplay = formatRuntime(movie.runtime);
          for (const show of movie.showtimes || []) {
            // show may be string "YYYY-MM-DD HH:MM (Note)" or dict {datetime, label}
            let dstr = "";
            if (typeof show === "object") {
              dstr = show.datetime;
            } else {
              const i = show.indexOf("(");
              dstr = i > -1 ? show.slice(0, i).trim() : show.trim();
            }

            const jsDate = new Date(dstr.replace(" ", "T"));
            const isoDate = dstr.slice(0, 10);
            const day = jsDate.toLocaleDateString("en-US", { weekday: "long" });
            const dateDisp = jsDate.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
            const timeDisp = toAmPm(jsDate);
            const time24 = to24h(jsDate);

            rows.push([
              theaterName,           // 0 Theater
              movie.title,           // 1 Movie
              day,                   // 2 Day
              dateDisp,              // 3 Date (display)
              timeDisp,              // 4 Time (display)
              runtimeDisplay,        // 5 Runtime (display)
              isoDate,               // 6 ISO Date (hidden)
              time24                 // 7 24h time (hidden)
            ]);
          }
        }
      }

      // Build the table
      const table = $('#movies').DataTable({
        data: rows,
        columns: [
          { title: "Theater" },
          { title: "Movie" },
          { title: "Day" },
          { title: "Date" },
          {
            title: "Time",
            render: function (data, type, row) {
              if (type === 'sort' || type === 'type') return row[7];
              return data;
            }
          },
          { title: "Runtime" },
          { visible: false }, // ISO date
          { visible: false }  // 24h time
        ],
        orderCellsTop: true,
        fixedHeader: true,
        pageLength: 25
      });

      // Populate the Theater dropdown filter with values we saw
      const theaterFilter = document.getElementById("theater-filter");
      [...theaterSet].sort().forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        theaterFilter.appendChild(opt);
      });

      // Hook up column text inputs (Movie, Day, Runtime)
      $('#movies thead tr.filters th').each(function (i) {
        const input = $('input', this);
        if (input.length) {
          input.on('keyup change', function () {
            if (table.column(i).search() !== this.value) {
              table.column(i).search(this.value).draw();
            }
          });
        }
      });

      // Theater dropdown filter (exact match)
      theaterFilter.addEventListener("change", function () {
        const v = this.value;
        if (v) {
          table.column(0).search('^' + v.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '$', true, false).draw();
        } else {
          table.column(0).search("").draw();
        }
      });

      // Time AM/PM select (column filter)
      document.getElementById("time-filter").addEventListener("change", function () {
        const val = this.value;
        if (val) {
          table.column(4).search(val, true, false).draw();
        } else {
          table.column(4).search("").draw();
        }
      });

      // Date picker in column header -> apply same exact-date global filter
      document.getElementById("date-filter-col").addEventListener("change", function () {
        exactDateFilter = this.value || "";
        // Keep global toolbar in sync visually
        document.getElementById("exactDate").value = exactDateFilter;
        table.draw();
      });

      // Global toolbar exact date + AM/PM
      document.getElementById("exactDate").addEventListener("change", function () {
        exactDateFilter = this.value || "";
        // Keep column header date picker in sync
        document.getElementById("date-filter-col").value = exactDateFilter;
        table.draw();
      });
      document.getElementById("ampmGlobal").addEventListener("change", function () {
        ampmGlobalFilter = this.value || "";
        table.draw();
      });
    })();
  </script>
</body>
</html>
